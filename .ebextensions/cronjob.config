files:
    /usr/local/sbin/run-es-job:
        mode: "000755"
        owner: root
        group: root
        content: |
            #!/bin/sh
            echo "## Running "$@" at $(date --iso-8601=seconds)" >> /var/log/jobs.log
            if [ -f /disable_es_jobs ]; then
                echo "disabled by file /disable_es_jobs" >> /var/log/jobs.log
                exit 0
            fi
            EB_APP_DIR="$(/opt/elasticbeanstalk/bin/get-config platformconfig -k AppDeployDir)"
            EB_APP_USER="$(/opt/elasticbeanstalk/bin/get-config platformconfig -k AppUser)"
            cd "$EB_APP_DIR"
            export $(< /opt/elasticbeanstalk/deployment/env)
            runuser -u $EB_APP_USER -- bin/rake "$@" >>/var/log/jobs.log 2>&1

    /etc/cron.d/energysparks:
        mode: "000644"
        owner: root
        group: root
        content: |
            PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin
            #
            # Check for DCC meters
            #
            0 1 * * * root run-es-job meters:check_for_dcc
            #
            # Load non-amr data feeds
            #
            0 3 * * * root run-es-job data_feeds:carbon_intensity_loader
            30 3,15 * * * root run-es-job data_feeds:solar_pv_tuos_loader
            50 3 * * * root run-es-job data_feeds:meteostat_loader
            55 3 * * * root run-es-job data_feeds:meteostat_back_fill
            35 3 * * * root run-es-job data_feeds:solar_pv_tuos_back_fill
            #
            # Import CSV files
            #
            15 5 * * * root run-es-job amr:import_all
            20 4 * * * root run-es-job solar:import_rtone_variant_readings
            #
            # Import Solar Edge data
            #
            15 4 * * * root run-es-job solar:import_solar_edge_readings
            #
            # Import Low carbon hub data
            #
            5 5 * * * root run-es-job solar:import_low_carbon_hub_readings
            #
            # Import n3rgy readings
            #
            0 14 * * * root run-es-job amr:import_n3rgy_readings
            10 14 * * * root run-es-job amr:import_n3rgy_tariffs
            #
            # Start daily regeneration jobs
            #
            0 6 * * * root run-es-job school:daily_regeneration
            #
            # Generate subscriptions
            #
            30 6 * * Wed root run-es-job alerts:generate_subscriptions
            #
            # EMail summary of imports
            #
            45 9 * * * root run-es-job amr_importer:send_daily_notification_email
            #
            # EMail summary of Rollbar errors from imports
            #
            # 0 9 * * * root run-es-job utility:custom_rollbar_reports
            #
            # Generate sitemap
            #
            0 1 * * * root run-es-job -s sitemap:refresh
            #
            # Send first target emails weekly on a Monday
            #
            30 08 * * 1 root run-es-job targets:send_first_target
            #
            # Send email with recently recorded activities weekly on a Monday
            #
            32 08 * * 1 root run-es-job recent_activities:send_email
            #
            # Send weekly email about target progress to admins
            #
            30 08 * * 5 root run-es-job targets:admin_report
            #
            # Send issues report to admins weekly on a Monday
            #
            15 08 * * 1 root run-es-job issues:send_user_report
            #
            # Resync translations with Transifex on Monday mornings
            #
            0 08 * * 1 root run-es-job i18n:transifex_load
            #
            # Delete old alert content
            #
            0 0 1 * * root run-es-job alerts:delete_alert_content
            #
            # Send Good Job queue metrics to AWS Cloudwatch
            #
            */5 * * * * root run-es-job jobs:send_good_job_queue_metrics_to_cloudwatch
            #
            # Send Review Group Tariffs Reminders
            #
            0 8 15 3,9 * root run-es-job school_groups:send_review_group_tariffs_reminder
            #
            # Send Review School Tariffs Reminders
            #
            0 8 15 3,9 * root run-es-job schools:send_review_school_tariffs_reminder
            #
            # Send Onboarding Reminder Emails
            #
            0 4 * * * root run-es-job onboarding:reminder_mailer

commands:
    # Remove baks else jobs get run twice
    remove_old_cron:
        command: "rm -f /etc/cron.d/*.bak"
