packages:
  yum:
    perl-DateTime: []
    perl-Sys-Syslog: []
    perl-LWP-Protocol-https: []
    perl-Switch: []
    perl-URI: []
    perl-Digest-SHA: []

sources:
  /opt/cloudwatch: https://aws-cloudwatch.s3.amazonaws.com/downloads/CloudWatchMonitoringScripts-1.2.1.zip

container_commands:
  01-setupmetricscron:
    command: |
      echo '*/5 * * * * root perl /opt/cloudwatch/aws-scripts-mon/mon-put-instance-data.pl `{"Fn::GetOptionSetting" : { "OptionName" : "CloudWatchMetrics", "DefaultValue" : "--mem-util" }}` >> /dev/null 2>&1' > /etc/cron.d/cwpump
  02-setupmemoryusagemetricscron:
      echo '*/5 * * * * aws cloudwatch put-metric-data --metric-name MemoryUsage --namespace DelayedJob --value=$(./current/script/delayed_job_memory_usage.sh) --unit Kilobytes --region=eu-west-2 --dimensions InstanceId=$(ec2-metadata --instance-id | cut -d " " -f 2)' > /etc/cron.d/cwpump
  03-setupnumberofprocessesscron:
      echo '*/5 * * * * aws cloudwatch put-metric-data --metric-name Processes --namespace DelayedJob --value=$(./current/script/delayed_job_number_of_processes.sh) --unit Count --region=eu-west-2 --dimensions InstanceId=$(ec2-metadata --instance-id | cut -d " " -f 2)' > /etc/cron.d/cwpump
  04-changeperm:
    command: chmod 644 /etc/cron.d/cwpump
  05-changeperm:
    command: chmod u+x /opt/cloudwatch/aws-scripts-mon/mon-put-instance-data.pl

option_settings:
  "aws:autoscaling:launchconfiguration" :
    IamInstanceProfile : "aws-elasticbeanstalk-ec2-role"
  "aws:elasticbeanstalk:customoption" :
    CloudWatchMetrics : "--mem-util --mem-used --mem-avail --auto-scaling"
