<div class="d-flex justify-content-between align-items-center">
  <h1>Tracking progress to reduce your <%= @fuel_type.to_s.humanize(capitalize: false) %> energy usage</h1>
  <div>
    <%= link_to "Review targets", school_school_target_path(@school, @school_target), class: "btn btn-outline-dark rounded-pill font-weight-bold" %>
    <%= link_to_help_for_feature :school_targets, css: "btn btn-outline-dark rounded-pill font-weight-bold" %>
  </div>
</div>

<% if @suggest_estimate_important %>
  <%= render 'schools/school_targets/prompt_to_add_estimate', school: @school, fuel_types: [@fuel_type.to_s] %>
<% end %>

<% if @recent_data %>
  <% if @latest_progress %>
    <% if @latest_progress == 0.0 %>
      <p>
        Unfortunately you are using as much <%= human_fuel_type(@fuel_type) %> as you did last year.
      </p>
    <% elsif @latest_progress > 0.0 %>
      <%= @latest_progress %>
      <p>
        Unfortunately you are using
        <%= format_target(@latest_progress, :relative_percent) %> more <%= human_fuel_type(@fuel_type) %> than last year.
      </p>
    <% else %>
      <p>
        Well done, you are using
        <%= format_target(@latest_progress, :relative_percent) %> less <%= human_fuel_type(@fuel_type) %> than last year.
      </p>
    <% end %>
  <% end %>
<% else %>
  <div class="row alert info-bar text-light bg-negative">
    <div class="col">
      <span class="align-middle">We have not received data for your <%= human_fuel_type(@fuel_type) %> usage for over thirty days. As a result your progress report will be out of date.</span>
    </div>
  </div>
<% end %>

<p>
  Your school has set a target to reduce its <%= human_fuel_type(@fuel_type, include_storage_heaters: true) %> usage by <%= @school_target.attributes[@fuel_type.to_s] %>% between <strong><%= nice_dates(@school_target.start_date) %></strong> and <strong><%= nice_dates(@school_target.target_date) %></strong>.
</p>

<% if @progress  %>

  <h3>Month by month progress</h3>

  <table class="table table-bordered table-hover table-sm">
    <thead class="thead-dark">
    <tr>
      <th>
        Month
      </th>
      <% @reporting_months.each do |month| %>
        <th class="text-right">
          <%= month.strftime('%b') %>
        </th>
      <% end %>
    </tr>
    </thead>
    <tbody>
    <%= render 'row', title: 'Target Consumption (kWh)', progress: @progress, data: @progress.monthly_targets_kwh, keys: @reporting_months, partial_months: {}, percentage_synthetic: @progress.percentage_synthetic, units: :kwh, final_row: false %>
    <%= render 'row', title: 'Actual Consumption (kWh)', progress: @progress, data: @progress.monthly_usage_kwh, keys: @reporting_months, partial_months: @progress.partial_months, percentage_synthetic: {}, units: :kwh, final_row: false %>
    <%= render 'row', title: 'Overall change since last year', progress: @progress, data: @progress.monthly_performance_versus_synthetic_last_year, keys: @reporting_months, partial_months: @progress.partial_months, percentage_synthetic: {}, units: :relative_percent, final_row: true %>
    </tbody>
  </table>

  <h3>Cumulative progress</h3>

  <table class="table table-bordered table-hover table-sm">
    <thead class="thead-dark">
    <tr>
      <th>
        Month
      </th>
      <% @reporting_months.each do |month| %>
        <th class="text-right">
          <%= month.strftime('%b') %>
        </th>
      <% end %>
    </tr>
    </thead>
    <tbody>
    <%= render 'row', title: 'Target Consumption (kWh)', data: @progress.cumulative_targets_kwh, keys: @reporting_months, partial_months: {}, percentage_synthetic: @progress.percentage_synthetic, units: :kwh, final_row: false %>
    <%= render 'row', title: 'Actual Consumption (kWh)', data: @progress.cumulative_usage_kwh, keys: @reporting_months, partial_months: @progress.partial_months, percentage_synthetic: {}, units: :kwh, final_row: false %>
    <%= render 'row', title: 'Overall performance since last year', data: @progress.cumulative_performance_versus_synthetic_last_year, keys: @reporting_months, partial_months: @progress.partial_months, percentage_synthetic: {}, units: :relative_percent, final_row: true %>
    </tbody>
  </table>

  <%= render 'footnotes', fuel_type: @fuel_type, school_target: @school_target, show_storage_heater_notes: @show_storage_heater_notes, progress: @progress %>

  <h3>Progress charts</h3>

  <%= render 'charts', school: @school, fuel_type: @fuel_type, progress: @progress %>

  <% if current_user.present? && current_user.analytics? %>
    <h2>Debug</h2>
    <pre class="debug">
      <%= JSON.pretty_generate(@debug_content) %>
    </pre>
  <% end %>
<% else %>

  <div class="alert alert-danger">
    <h4>Unfortunately due to an error we are currently unable to display your detailed progress report</h4>

    <% if @bad_estimate %>
      <p>
        The <%= link_to 'annual estimate', school_estimated_annual_consumptions_path(@school) %> of your <%= @fuel_type %> usage that has been provided for your school is too low.
      </p>
      <p>
        Please <%= link_to 'review your estimate and our guidance', school_estimated_annual_consumptions_path(@school) %> to see if it is correct.
      </p>
      <p>
        In the meantime, we have been notified about this error and will investigate.
      </p>
    <% else %>
      <p>We have been notified about this error and will investigate.</p>
    <% end %>
  </div>

  <% if current_user.present? && current_user.analytics? %>
  <div class="alert alert-secondary">
    <h4>Debug</h4>
    <p><strong>Error</strong>: <%= @debug_error if @debug_error.present? %></p>
    <p><strong>Problem</strong>: <%= @debug_problem if @debug_problem.present? %></p>
  </div>
  <% end %>


<% end %>
