<%= render 'header', title: 'Issues & Notes' do %>
  <% if @issueable.try(:school_group) %>
    <%= header_nav_link "#{@issueable.school_group.name} school group", admin_school_group_path(@issueable.school_group) %>
  <% elsif @issueable %>
    <%= header_nav_link "#{@issueable.name} #{@issueable.model_name.human.downcase}", [:admin, @issueable] %>
  <% end %>
<% end %>
<% if @issueable %>
  <div class="d-flex">
    <div>
      <%= link_to 'Issues & Notes', admin_issues_path %>&nbsp;>
      <%= @issueable.model_name.human.capitalize %> >
      <%= @issueable.try(:name) %>
    </div>
    <div class="ms-auto"><%= render 'new_issues_links', issueable: @issueable %></div>
  </div>
<% end %>
<div class="bg-light ps-2 pt-2 my-2 border rounded-2">
  <%= form_tag polymorphic_path(
        @issueable ? [:admin, @issueable, Issue] : [:admin, Issue]
      ),
               method: :get do %>
    <div class='d-flex justify-content-between flex-wrap align-items-center'>
      <div class="me-2 mb-2">
        <%= text_field_tag :search, params[:search], autocomplete: 'off',
                                                     placeholder: 'Search issues...',
                                                     width: 200,
                                                     class: '' %>
      </div>
      <div class="me-2 mb-2">
        <%= select_tag :user,
                       options_from_collection_for_select(User.admins_by_name, :id, :display_name, params[:user]),
                       include_blank: 'Any admin user',
                       class: 'form-control' %>
      </div>
      <div class="me-2 mb-2">
        <%= select_tag :review_date,
                       options_for_select([['Next review date not set', :review_unset],
                                           ['Next review date in next week', :review_next_week],
                                           ['Next review date overdue', :review_overdue]],
                                          params[:review_date]),
                       include_blank: 'Any next review date',
                       class: 'form-control' %>

      </div>
      <div class="nowrap me-2 mb-2 mt-1 ensure-one-checked">
        <%= label_tag :issue_type, 'Type:', class: 'small' %>
        <% Issue.issue_types.keys.each do |issue_type, issue_type_id| %>
          <%= check_box_tag('issue_types[]', issue_type, (params[:issue_types] ||= []).include?(issue_type),
                            id: issue_type, class: "badge-toggle-#{Issue.issue_type_classes[issue_type.to_sym]}") %>
          <%= label_tag issue_type, issue_type.capitalize,
                        data: { toggle: 'tooltip', placement: 'bottom', delay: { "show": 500, "hide": 100 } },
                        title: 'Select at least one' %>
        <% end %>
      </div>
      <div class="nowrap me-2 mb-2 mt-1 ensure-one-checked">
        <%= label_tag :status, 'Status:', class: 'small' %>
        <% Issue.statuses.keys.each do |status, status_id| %>
          <%= check_box_tag('statuses[]', status, (params[:statuses] ||= []).include?(status),
                            id: status,
                            class: "badge badge-pill-toggle-#{Issue.status_classes[status.to_sym]}") %>
          <%= label_tag status, status.capitalize,
                        data: { toggle: 'tooltip', placement: 'bottom', delay: { "show": 500, "hide": 100 } },
                        title: 'Select at least one' %>
        <% end %>
      </div>
      <div class="ms-xxl-auto me-2 mb-2">
        <%= submit_tag 'Filter', class: 'btn btn-sm' %>
        <%= link_to 'CSV',
                    url_for(request.query_parameters.merge(format: :csv)),
                    class: 'btn btn-sm' %>
      </div>
    </div>
  <% end %>
</div>

<% if @issues.any? %>
  <% if @issueable %>
    <div class="container">
      <% @issues.each do |issue| %>
        <%= render 'issue', issue: issue, single: false, issueable: @issueable %>
      <% end %>
    </div>
  <% else %>
    <%= render 'issues_list', issues: @issues %>
  <% end %>
  <%= render 'shared/pagy_footer' %>
<% else %>
  <p>No issues or notes to display.</p>
<% end %>
