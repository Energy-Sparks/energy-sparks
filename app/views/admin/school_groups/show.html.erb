<div class="d-flex justify-content-between align-items-center">
  <h1><%= @school_group.name %> School Group</h1>
  <div>
    <%= header_nav_link 'All school groups', admin_school_groups_url %>
  </div>
</div>
<p>Pupils in active schools: <span class="badge badge-success"><%= number_with_delimiter @school_group.schools.visible.map(&:number_of_pupils).compact.sum %></span></p>
<div class="row">
  <div class="col-lg-12">
    <div class="card-deck">
      <div class="card">
        <div class="card-body">
          <div>Active <span class="float-right badge badge-success"><%= @school_group.schools.visible.count %></span></div>
          <div>Active (with data visible) <span class="float-right badge badge-success"><%= @school_group.schools.visible.data_enabled.count %></span></div>
          <div>Invisible <span class="float-right badge badge-info"><%= @school_group.schools.not_visible.count %></span></div>
          <div>Onboarding <span class="float-right badge badge-warning"><%= @school_group.school_onboardings.select(&:incomplete?).count %></span></div>
          <div>Removed <span class="float-right badge badge-secondary"><%= @school_group.schools.inactive.count %></span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <% School.school_types.keys.each do |school_type| %>
            <div><%= school_type.humanize %> <span class="float-right badge badge-success"><%= @school_group.schools.visible.where(school_type: school_type).count %></span></div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="bg-light p-2 my-2 d-flex justify-content-between">
  <%= link_to 'View', school_group_path(@school_group), class: 'btn btn-sm' %>
  <%= link_to 'Edit', edit_admin_school_group_path(@school_group), class: 'btn btn-sm' %>
  <%= link_to 'Manage partners', admin_school_group_partners_path(@school_group), class: 'btn btn-sm' %>
  <%= link_to 'Meter attributes', admin_school_group_meter_attributes_path(@school_group), class: 'btn btn-sm' %>
  <%= link_to 'Meter report', admin_school_group_meter_report_path(@school_group), class: 'btn btn-sm' %>
  <%= link_to 'Download meter report', admin_school_group_meter_report_path(@school_group, format: :csv) , class: 'btn btn-sm' %>
  <div title="School groups can only be deleted if there are no associated schools or users" rel="tooltip">
    <%= link_to 'Delete', admin_school_group_path(@school_group), method: :delete, data: { confirm: 'Are you sure?' }, class: "btn btn-sm#{' disabled' unless @school_group.safe_to_destroy?}" %>
  </div>
</div>

<%= render 'schools_tabs' %>

<div class="tab-content" id="school-group-schools-content">
  <div class="tab-pane fade show active" id="active-content" role="tabpanel" aria-labelledby="active-tab">
    <table id="active" class="table table-striped">
      <% @school_group.schools.active.data_enabled.by_name.each do |school| %>
        <tr>
          <td><%= link_to_if school.school_onboarding, school.name, [:edit, :admin, school.school_onboarding, :configuration] %></td>
          <td><%= render 'shared/school_status_buttons', school: school %></td>
          <td class="nowrap text-right">
            <%= link_to 'Edit', edit_school_path(school), class: "btn btn-sm" %>
            <%= link_to 'Users', school_users_path(school), class: "btn btn-sm" %>
            <%= link_to 'Meters', school_meters_path(school), class: "btn btn-sm" %>
          </td>
        </tr>
      <% end %>
    </table>
  </div>
  <div class="tab-pane fade" id="onboarding-content" role="tabpanel" aria-labelledby="onboarding-tab">
    <table id="onboarding" class="table table-striped">
    <%= simple_form_for @school_group, html: { class: 'form-group', method: 'post' } do |f| %>
      <% @school_group.school_onboardings.by_name.select(&:incomplete?).each do |onboarding| %>
        <tr>
          <td><%= f.check_box :school_onboarding_ids, { multiple: true, checked: false }, onboarding.id, nil %></td>
          <td><%= link_to onboarding.school_name, onboarding_path(onboarding) %></td>
          <td><%= onboarding.contact_email %> <%= link_to 'Change', edit_admin_school_onboarding_email_path(onboarding), class: 'btn btn-warning btn-sm' if onboarding.has_only_sent_email_or_reminder? %></td>
          <td data-order="<%= onboarding.events.maximum(:created_at) %>"><%= nice_date_times(onboarding.events.maximum(:created_at)) %></td>
          <td><%= SchoolOnboardingEvent.events.key(onboarding.events.maximum(:event)).try(:humanize) %></td>
          <td class="nowrap">
            <%= link_to 'Send reminder email', admin_school_onboarding_reminder_path(onboarding), class: 'btn btn-warning btn-sm', method: :post %>
            <% if onboarding.school && onboarding.school.consent_grants.any? %>
              <%= link_to 'Make visible', school_visibility_path(onboarding.school), class: 'btn btn-sm', method: :post %>
            <% else %>
              <%= link_to 'Edit', edit_admin_school_onboarding_path(onboarding), class: 'btn btn-sm' %>
            <% end %>
            <%= link_to 'Delete', admin_school_onboarding_path(onboarding), class: 'btn btn-sm', method: :delete, data: {confirm: 'Are you sure?'} %>
          </td>
        </tr>
      <% end %>
    </table>
    <% end %>
  </div>
  <div class="tab-pane fade" id="removed-content" role="tabpanel" aria-labelledby="removed-tab">
    Removed
  </div>
</div>
